x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
    tag: "{{.Name}}"

configs:
  loki-config:
    content: |
      auth_enabled: false
      server:
        http_listen_port: 3100
      common:
        instance_addr: 127.0.0.1
        path_prefix: /loki
        storage:
          filesystem:
            chunks_directory: /loki/chunks
            rules_directory: /loki/rules
        replication_factor: 1
        ring:
          kvstore:
            store: inmemory
      schema_config:
        configs:
          - from: 2020-10-24
            store: tsdb
            object_store: filesystem
            schema: v13
            index:
              prefix: index_
              period: 24h
      limits_config:
        retention_period: 168h
        ingestion_rate_mb: 4
        ingestion_burst_size_mb: 6
        max_streams_per_user: 10000
        max_line_size: "256000"
      ruler:
        alertmanager_url: http://localhost:9093

  prometheus-config:
    content: |
      global:
        scrape_interval: 15s
      scrape_configs:
        - job_name: "prometheus"
          static_configs:
            - targets: ["localhost:9090"]
        - job_name: "grafana"
          static_configs:
            - targets: ["grafana:3000"]
        - job_name: "node"
          static_configs:
            - targets: ["localhost:9100"]

  grafana-ds:
    content: |
      apiVersion: 1
      datasources:
        - name: Loki
          type: loki
          access: proxy
          url: http://loki:3100
          version: 1
          editable: false
          isDefault: true
        - name: Prometheus
          type: prometheus
          access: proxy
          url: http://prometheus:9090
          version: 1
          editable: false
          isDefault: false

services:
  grafana:
    image: grafana/grafana:11.0.0
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=false
      - GF_AUTH_DISABLE_LOGIN_FORM=false
      - GF_SECURITY_ADMIN_USER=${GF_SECURITY_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD}
      - GF_FEATURE_TOGGLES_ENABLE=accessControlOnCall lokiLogsDataplane
      - GF_INSTALL_PLUGINS=https://storage.googleapis.com/integration-artifacts/grafana-lokiexplore-app/grafana-lokiexplore-app-latest.zip;grafana-lokiexplore-app
      - GF_SERVER_ROOT_URL=${GF_SERVER_ROOT_URL:-http://localhost:3000}
    volumes:
      - grafana_data:/var/lib/grafana
    configs:
      - source: grafana-ds
        target: /etc/grafana/provisioning/datasources/ds.yaml
    logging: *default-logging
    networks:
      - monitoring
    restart: unless-stopped

  loki:
    image: grafana/loki:3.0.0
    container_name: loki
    command: -config.file=/etc/loki/loki.yaml
    # Internal only
    expose:
      - "3100"
    volumes:
      - loki_data:/loki
    configs:
      - source: loki-config
        target: /etc/loki/loki.yaml
    logging: *default-logging
    networks:
      - monitoring
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:v3.7.3
    container_name: prometheus
    command: --config.file=/etc/prometheus/prometheus.yml
    # Internal only
    expose:
      - "9090"
    volumes:
      - prometheus_data:/prometheus
    configs:
      - source: prometheus-config
        target: /etc/prometheus/prometheus.yml
    logging: *default-logging
    networks:
      - monitoring
    restart: unless-stopped

  # Optional: Node Exporter for host metrics
  # node-exporter:
  #   image: prom/node-exporter:latest
  #   container_name: node-exporter
  #   expose:
  #     - "9100"
  #   volumes:
  #     - /proc:/host/proc:ro
  #     - /sys:/host/sys:ro
  #     - /:/rootfs:ro
  #   command:
  #     - '--path.procfs=/host/proc'
  #     - '--path.sysfs=/host/sys'
  #     - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
  #   networks:
  #     - monitoring
  #   restart: unless-stopped

volumes:
  grafana_data:
    driver: local
  loki_data:
    driver: local
  prometheus_data:
    driver: local

networks:
  monitoring:
    driver: bridge
